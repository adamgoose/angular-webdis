/**
 * Adam Engebretson
 *
 * Adam Engebretson <http://github.com/adamgoose>
 * Created and maintained by Adam Engebretson
 *
 * Copyright (c) 2014 Adam Engebretson.
 * Licensed under the MIT License (MIT).
 */
!function(t){"use strict";t.service("WebdisSocket",["$timeout",function(t){this.callbacks={},this.scopes={},this.init=function(s,n){this.socket=new WebSocket("ws://"+s+":"+n+"/");var o=this;return o.socket.onopen=function(){var t=["SUBSCRIBE"];angular.forEach(o.callbacks,function(s,n){t.push(n)}),o.socket.send(angular.toJson(t))},o.socket.onclose=function(){t(function(){o.init(s,n),console.log("Connection closed, trying to reconnect!")},1500)},o.socket.onmessage=function(t){var s=angular.fromJson(t.data).SUBSCRIBE,n=s[0],i=s[1],c=s[2];"message"==n&&o.dispatchEvents(i,c)},this},this.dispatchEvents=function(t,s){var n;try{n=angular.fromJson(s)}catch(o){n=s}this.callbacks[t](n,t),angular.isDefined(this.scopes[t])&&this.scopes[t].$apply()},this.subscribe=function(s,n,o){if(this.callbacks[s]=n,this.scopes[s]=o,1==this.socket.readyState){var i=this.socket,c=10*this.callbacks.length;t(function(){i.send(angular.toJson(["SUBSCRIBE",s]))},c)}}}]),t.provider("Webdis",function(){this.host=null,this.port="7379",this.setHost=function(t){this.host=t},this.setPort=function(t){this.port=t},this.$get=["WebdisSocket",function(t){var s=this.host,n=this.port;return t.init(s,n)}]})}(angular.module("adamgoose.webdis",[]));